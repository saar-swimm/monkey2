import datetime
from copy import deepcopy

from bson import ObjectId

from monkey_island.cc.services.reporting.exploitations.monkey_exploitation import (
    get_exploits_used_on_node,
)

TELEM_ID = {
    "exploit_creds": ObjectId(b"123456789000"),
    "system_info_creds": ObjectId(b"987654321000"),
    "no_creds": ObjectId(b"112233445566"),
    "monkey": ObjectId(b"665544332211"),
}
MONKEY_GUID = "67890"
USER = "user-name"
PWD = "password123"
LM_HASH = "e52cac67419a9a22664345140a852f61"
NT_HASH = "a9fdfa038c4b75ebc76dc855dd74f0da"
VICTIM_IP = "0.0.0.0"
VICTIM_DOMAIN_NAME = "domain-name"
HOSTNAME = "name-of-host"

# Below telem constants only contain fields relevant to current tests

EXPLOIT_TELEMETRY_TELEM = {
    "_id": TELEM_ID["exploit_creds"],
    "monkey_guid": MONKEY_GUID,
    "telem_category": "exploit",
    "data": {
        "machine": {
            "ip_addr": VICTIM_IP,
            "domain_name": VICTIM_DOMAIN_NAME,
        },
        "info": {
            "credentials": {
                USER: {
                    "username": USER,
                    "lm_hash": LM_HASH,
                    "ntlm_hash": NT_HASH,
                }
            }
        },
    },
}

SYSTEM_INFO_TELEMETRY_TELEM = {
    "_id": TELEM_ID["system_info_creds"],
    "monkey_guid": MONKEY_GUID,
    "telem_category": "system_info",
    "timestamp": datetime.datetime(2021, 2, 19, 9, 0, 14, 984000),
    "command_control_channel": {
        "src": "192.168.56.1",
        "dst": "192.168.56.2",
    },
    "data": {
        "credentials": {
            USER: {
                "password": PWD,
                "lm_hash": LM_HASH,
                "ntlm_hash": NT_HASH,
            }
        }
    },
}

NO_CREDS_TELEMETRY_TELEM = {
    "_id": TELEM_ID["no_creds"],
    "monkey_guid": MONKEY_GUID,
    "telem_category": "exploit",
    "timestamp": datetime.datetime(2021, 2, 19, 9, 0, 14, 984000),
    "command_control_channel": {
        "src": "192.168.56.1",
        "dst": "192.168.56.2",
    },
    "data": {
        "machine": {
            "ip_addr": VICTIM_IP,
            "domain_name": VICTIM_DOMAIN_NAME,
        },
        "info": {"credentials": {}},
    },
}

MONKEY_TELEM = {"_id": TELEM_ID["monkey"], "guid": MONKEY_GUID, "hostname": HOSTNAME}

NODE_DICT = {
    "id": "602f62118e30cf35830ff8e4",
    "label": "WinDev2010Eval.mshome.net",
    "group": "monkey_windows",
    "os": "windows",
    "dead": True,
    "exploits": [
        {
            "exploitation_result": True,
            "exploiter": "Log4ShellExploiter",
            "info": {
                "display_name": "Log4j",
                "started": datetime.datetime(2021, 2, 19, 9, 0, 14, 950000),
                "finished": datetime.datetime(2021, 2, 19, 9, 0, 14, 950000),
                "vulnerable_urls": [],
                "vulnerable_ports": [],
                "executed_cmds": [],
            },
            "attempts": [],
            "timestamp": datetime.datetime(2021, 2, 19, 9, 0, 14, 984000),
            "origin": "MonkeyIsland : 192.168.56.1",
        },
        {
            "exploitation_result": True,
            "exploiter": "ZerologonExploiter",
            "info": {
                "display_name": "Zerologon",
                "started": datetime.datetime(2021, 2, 19, 9, 0, 15, 16000),
                "finished": datetime.datetime(2021, 2, 19, 9, 0, 15, 17000),
                "vulnerable_urls": [],
                "vulnerable_ports": [],
                "executed_cmds": [],
            },
            "attempts": [],
            "timestamp": datetime.datetime(2021, 2, 19, 9, 0, 15, 60000),
            "origin": "MonkeyIsland : 192.168.56.1",
        },
    ],
}

NODE_DICT_DUPLICATE_EXPLOITS = deepcopy(NODE_DICT)
NODE_DICT_DUPLICATE_EXPLOITS["exploits"][1] = NODE_DICT_DUPLICATE_EXPLOITS["exploits"][0]

NODE_DICT_FAILED_EXPLOITS = deepcopy(NODE_DICT)
NODE_DICT_FAILED_EXPLOITS["exploits"][0]["exploitation_result"] = False
NODE_DICT_FAILED_EXPLOITS["exploits"][1]["exploitation_result"] = False


def test_get_exploits_used_on_node__2_exploits():
    exploits = get_exploits_used_on_node(NODE_DICT)
    assert sorted(exploits) == sorted(["Zerologon Exploiter", "Log4Shell Exploiter"])


def test_get_exploits_used_on_node__duplicate_exploits():
    exploits = get_exploits_used_on_node(NODE_DICT_DUPLICATE_EXPLOITS)
    assert exploits == ["Log4Shell Exploiter"]


def test_get_exploits_used_on_node__failed():
    exploits = get_exploits_used_on_node(NODE_DICT_FAILED_EXPLOITS)
    assert exploits == []
